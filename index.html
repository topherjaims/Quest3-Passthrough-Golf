<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Quest 3 Golf – WebXR AR/VR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <style>
    :root { --hud-bg:#000c; --hud-fg:#fff }
    body { margin:0 }
    #hud{position:fixed;left:12px;top:12px;z-index:10;display:flex;gap:8px;flex-wrap:wrap;align-items:center;font:16px system-ui}
    #hud .pill{background:var(--hud-bg);color:var(--hud-fg);padding:8px 12px;border-radius:10px;border:0}
    #hud .btn{cursor:pointer}
    #status{min-width:240px}
  </style>
</head>
<body>
<div id="hud">
  <span class="pill">Hold trigger & swing. Release to hit.</span>
  <button id="enterAR" class="pill btn" style="display:none">Enter AR</button>
  <button id="enterVR" class="pill btn" style="display:none">Enter VR</button>
  <button id="reset"   class="pill btn">Reset ball</button>
  <label class="pill"><input id="lefty" type="checkbox"> Left-handed</label>
  <span id="status" class="pill">checking WebXR…</span>
</div>

<a-scene
  xr-mode-ui="enabled: false"
  renderer="alpha: true; colorManagement: true"
  background="transparent: true"
  webxr="optionalFeatures: local-floor, bounded-floor, dom-overlay; overlayElement: #hud">

  <!-- assets: put the canvas here so A-Frame treats it as a live texture -->
  <a-assets>
    <canvas id="uicanvas" width="1280" height="720"></canvas>
  </a-assets>

  <a-entity light="type: hemisphere; intensity: 1"></a-entity>

  <!-- big simulator screen in front of you -->
  <a-entity id="screen"
            position="0 1.6 -3.5"
            geometry="primitive: plane; width: 5; height: 2.8125"
            material="shader: flat; src: #uicanvas; transparent: true; side: double">
  </a-entity>

  <!-- optional rays for debugging -->
  <a-entity id="rayR" laser-controls="hand: right"></a-entity>
  <a-entity id="rayL" laser-controls="hand: left"></a-entity>

  <script>
    // ===== Canvas range + ball =====
    const cvs = document.getElementById('uicanvas'), ctx = cvs.getContext('2d');
    function drawBG(){
      ctx.fillStyle='#0b2a'; ctx.fillRect(0,0,cvs.width,cvs.height);
      ctx.strokeStyle='#1d5'; ctx.lineWidth=2;
      for(let y=640;y>120;y-=44){ctx.beginPath();ctx.moveTo(80,y);ctx.lineTo(cvs.width-80,y);ctx.stroke();}
      ctx.fillStyle='#9f9'; ctx.font='20px system-ui';
      for(let i=50;i<=300;i+=50){const y=640-i*1.6; if(y>120) ctx.fillText(i+'y', 20, y);}
      ctx.strokeStyle='#6fa'; ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(cvs.width/2,700); ctx.lineTo(cvs.width/2,120); ctx.stroke();
    }
    function drawBall(x,y){ ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(x,y,7,0,Math.PI*2); ctx.fill(); }

    let ball={x:120,y:680,vx:0,vy:0,flying:false};
    const sx=240, sy=240, g=9.81, dt=1/60;
    function resetBall(){ ball={x:120,y:680,vx:0,vy:0,flying:false}; }
    function launch(v, loft=12, side=0){
      const L=loft*Math.PI/180, S=side*Math.PI/180, vh=v*Math.cos(L);
      ball.vx=(vh*Math.cos(S))*(sx*dt);
      ball.vy=-(v*Math.sin(L))*(sy*dt);
      ball.flying=true;
    }
    function step(){ if(!ball.flying) return; ball.x+=ball.vx; ball.y+=ball.vy; ball.vy+=(g*sy*dt*dt); if(ball.y>680){ball.y=680; ball.flying=false;} }

    // ===== Controller swing capture =====
    let last={t:0,pos:null}, held=false, peak=0, lastYaw=0, lefty=false;
    const scene=document.querySelector('a-scene');
    document.getElementById('lefty').onchange = e => lefty = e.target.checked;

    function srcFor(hand){ const s=scene.renderer.xr.getSession(); if(!s) return null;
      return [...s.inputSources].find(x => x && x.handedness===hand && x.gripSpace); }
    function activeSrc(){ return (lefty && srcFor('left')) || srcFor('right') || srcFor('left'); }

    function poll(frame){
      const s=scene.renderer.xr.getSession(); if(!s) return;
      const ref=scene.renderer.xr.getReferenceSpace(), src=activeSrc(); if(!src) return;
      const pose=frame.getPose(src.gripSpace, ref); if(!pose) return;
      const t=frame.predictedDisplayTime ?? performance.now()/1000;
      if(last.pos){
        const d=Math.max(1/120, t-last.t);
        const p=pose.transform.position, dx=p.x-last.pos.x, dy=p.y-last.pos.y, dz=p.z-last.pos.z;
        const mps=Math.hypot(dx,dy,dz)/d; if(held) peak=Math.max(peak,mps);
        const q=pose.transform.orientation;
        const yaw=Math.atan2(2*(q.w*q.y+q.x*q.z), 1-2*(q.y*q.y+q.z*q.z))*180/Math.PI; lastYaw=yaw;
      }
      last={t, pos: pose.transform.position};
    }
    function handleButtons(){
      const src=activeSrc(); if(!src || !src.gamepad) return;
      const trig=src.gamepad.buttons[0];
      if(trig?.pressed && !held){ held=true; peak=0; }
      if(!trig?.pressed && held){ held=false;
        const v=Math.min(90, peak*6 + 10), side=Math.max(-15, Math.min(15, lastYaw*0.2));
        resetBall(); launch(v,12,side);
      }
    }

    // ===== Render loop =====
    scene.renderer.setAnimationLoop((t,frame)=>{
      drawBG(); step(); drawBall(ball.x,ball.y);
      const mesh=scene.querySelector('#screen').getObject3D('mesh');
      if(mesh && mesh.material && mesh.material.map) mesh.material.map.needsUpdate=true;
      if(frame){ poll(frame); handleButtons(); }
    });

    scene.addEventListener('loaded', ()=>{
      // If A-Frame hasn’t bound the canvas yet (rare), force it:
      const mesh=scene.querySelector('#screen').getObject3D('mesh');
      if(mesh && (!mesh.material.map || !mesh.material.map.isTexture)){
        mesh.material.map = new THREE.CanvasTexture(cvs);
        mesh.material.needsUpdate = true;
      }
    });

    // ===== Session/UI =====
    const status = document.getElementById('status');
    document.getElementById('reset').onclick = resetBall;

    async function setupXR(){
      if(!('xr' in navigator)){ status.textContent='WebXR not available on this browser'; return; }
      let arOK=false, vrOK=false;
      try{ arOK = await navigator.xr.isSessionSupported('immersive-ar'); }catch(e){}
      try{ vrOK = await navigator.xr.isSessionSupported('immersive-vr'); }catch(e){}
      if(arOK){ document.getElementById('enterAR').style.display='inline-block'; status.textContent='AR available'; }
      else { status.textContent='AR not available; use VR'; }
      if(vrOK){ document.getElementById('enterVR').style.display='inline-block'; }

      document.getElementById('enterAR').onclick = async ()=>{
        try{
          const s = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures:['local-floor'],
            optionalFeatures:['bounded-floor','hand-tracking','dom-overlay'],
            domOverlay:{ root: document.body }
          });
          await scene.renderer.xr.setSession(s);
        }catch(e){ alert('AR failed: '+e.message); }
      };
      document.getElementById('enterVR').onclick = async ()=>{
        try{
          const s = await navigator.xr.requestSession('immersive-vr', { optionalFeatures:['local-floor','bounded-floor'] });
          await scene.renderer.xr.setSession(s);
        }catch(e){ alert('VR failed: '+e.message); }
      };
    }
    setupXR();
  </script>
</a-scene>
</body>
</html>
